apiVersion: apps/v1
kind: Deployment
metadata:
  name: chaincopilot
  labels:
    app: chaincopilot
spec:
  replicas: 1
  selector:
    matchLabels:
      app: chaincopilot
  template:
    metadata:
      labels:
        app: chaincopilot
    spec:
      serviceAccountName: chaincopilot-sa
      containers:
        # Node.js frontend container
        - name: chaincopilot
          image: us-central1-docker.pkg.dev/mythic-delight-114820/chaincopilot/chaincopilot:latest
          ports:
            - containerPort: 3000
          env:
            - name: NODE_ENV
              value: "production"
            - name: GOOGLE_API_KEY
              valueFrom:
                secretKeyRef:
                  name: chaincopilot-secrets
                  key: google-api-key
            # Connect to Python sidecar via localhost (same pod)
            - name: PYTHON_SERVICE_URL
              value: "http://localhost:8000"
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 5

        # Python FastAPI sidecar for OpenBB (persistent, no spawn overhead)
        - name: python-openbb
          image: us-central1-docker.pkg.dev/mythic-delight-114820/chaincopilot/chaincopilot-python:latest
          ports:
            - containerPort: 8000
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "768Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
---
# Backend config for extended timeout
apiVersion: cloud.google.com/v1
kind: BackendConfig
metadata:
  name: chaincopilot-backend-config
spec:
  timeoutSec: 120
  connectionDraining:
    drainingTimeoutSec: 60
  # Session affinity: users stick to same pod for cached data
  sessionAffinity:
    affinityType: "GENERATED_COOKIE"
    affinityCookieTtlSec: 300
---
apiVersion: v1
kind: Service
metadata:
  name: chaincopilot-service
  annotations:
    cloud.google.com/backend-config: '{"default": "chaincopilot-backend-config"}'
spec:
  type: ClusterIP
  selector:
    app: chaincopilot
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000
---
# Google-managed SSL certificate for both domains
apiVersion: networking.gke.io/v1
kind: ManagedCertificate
metadata:
  name: chaincopilot-cert
spec:
  domains:
    - chaincopilot.app
    - chaincopilot.cloud
---
# Ingress with static IP and HTTPS
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: chaincopilot-ingress
  annotations:
    kubernetes.io/ingress.global-static-ip-name: chaincopilot-ip
    networking.gke.io/managed-certificates: chaincopilot-cert
    kubernetes.io/ingress.class: gce
spec:
  defaultBackend:
    service:
      name: chaincopilot-service
      port:
        number: 80
